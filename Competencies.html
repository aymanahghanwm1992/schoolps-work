<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <link rel="icon" type="image/png" href="https://img.icons8.com/?size=100&id=EBTRnyzoVTBa&format=png&color=000000">
    <title>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© ÙƒÙØ§Ø¡Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Cairo', sans-serif; background: #f0f4f8; margin:0; padding:0; display:flex; min-height:100vh; flex-direction:column; }
        .container { max-width: 1200px; margin: auto; padding: 20px; }
        .card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 15px;
            text-align: center;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); }
        .avatar { width:100px; height:100px; border-radius:50%; object-fit:cover; margin:auto; border: 3px solid #3b82f6; }
        .modal { z-index: 100; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #3b82f6, #6366f1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: linear-gradient(180deg, #2563eb, #4f46e5); }
        
        .stat-card { position: relative; overflow: hidden; }
        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.5s;
        }
        .stat-card:hover::before { animation: shine 1.5s infinite; }
        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        .ripple { position: relative; overflow: hidden; }
        .ripple::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .ripple:active::after { width: 200px; height: 200px; }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .pulse { animation: pulseEffect 0.5s ease-in-out; }
        @keyframes pulseEffect {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        .card-hover-effect { position: relative; overflow: hidden; }
        .card-hover-effect::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.2), transparent);
            transition: left 0.5s;
        }
        .card-hover-effect:hover::before { left: 100%; }
        
        @keyframes slideDown {
            from { transform: translate(-50%, -100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translate(-50%, 0); opacity: 1; }
            to { transform: translate(-50%, -100%); opacity: 0; }
        }
        @keyframes slideInRight {
            from { transform: translateX(50px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .page-content { flex: 1; }
        /* Non-blocking top progress bar */
        #top-progress { position: fixed; top: 0; left: 0; height: 3px; width: 0; background: linear-gradient(90deg, #3b82f6, #8b5cf6); z-index: 1000; transition: width 0.3s ease; box-shadow: 0 1px 6px rgba(59,130,246,0.5); }
        /* Subtle mobile tweaks */
        @media (max-width: 640px){
          .container { padding: 12px; }
          .avatar { width: 80px; height: 80px; }
          #note-edit-modal .max-w-lg{ max-width: 95vw; }
        }

        /* Ø²Ø± Ø¯Ø§Ø¦Ø±ÙŠ Ø¹Ø§Ø¦Ù… + ØªÙ„Ù…ÙŠØ­ (ÙŠØ´Ø¨Ù‡ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©) */
        .circle-action { width: 52px; height: 52px; border-radius: 50%; border: 2px solid #10b981; background:#fff; color:#0f766e; display:flex; align-items:center; justify-content:center; font-size:22px; box-shadow: 0 8px 22px rgba(0,0,0,.10); transition: transform .15s ease, background .2s ease, color .2s ease; position: relative; }
        .circle-action:hover { transform: translateY(-2px); background:#ecfdf5; color:#065f46; }
        .circle-action .btn-tooltip { position:absolute; left: 60px; right:auto; top:50%; transform: translateY(-50%) translateX(-6px); background:#fff; color:#111827; border:1px solid #e5e7eb; border-radius:10px; padding:6px 10px; font-size:12px; font-weight:800; white-space:nowrap; box-shadow:0 6px 16px rgba(0,0,0,.08); opacity:0; pointer-events:none; transition: opacity .15s ease, transform .15s ease; }
        .circle-action:focus-visible .btn-tooltip, .circle-action:hover .btn-tooltip { opacity:1; transform: translateY(-50%) translateX(0); }
        @media (max-width: 767.98px){
          .circle-action .btn-tooltip { right:auto; left:50%; top:auto; bottom:60px; transform: translate(-50%, 6px); }
          .circle-action:hover .btn-tooltip, .circle-action:focus-visible .btn-tooltip { transform: translate(-50%, 0); }
        }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„ØµØºÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ */
        @media (max-width: 480px){
          #teachers, #subjects, #classes, #students { grid-template-columns: 1fr !important; gap: 12px !important; }
          .card { padding: 12px; }
          .container { padding: 10px; }
        }
        @media (max-width: 360px){
          .avatar { width:72px; height:72px; }
          h1.text-4xl { font-size: 1.6rem; }
          .text-lg { font-size: 1rem; }
        }
    </style>
</head>
<body>
<div id="top-progress"></div>
<!-- Ø²Ø± Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª (Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¯Ø§Ø¦Ø±ÙŠØ© Ù…Ø¹ ØªÙ„Ù…ÙŠØ­) -->
<a href="https://schoolps.vercel.app/Rewards.html" target="_blank" rel="noopener" aria-label="ÙØªØ­ Ø´Ø§Ø´Ø© Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª"
   class="fixed top-4 left-4 z-[1200]">
  <button class="circle-action" type="button">
    ğŸ†
    <span class="btn-tooltip">Ø´Ø§Ø´Ø© Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª</span>
  </button>
</a>
<div class="page-content">
<div class="container flex">
    <div id="sidebar" class="w-full md:w-1/4 p-4 ml-6 bg-gradient-to-br from-white to-blue-50 rounded-2xl shadow-2xl sticky top-4 self-start border border-blue-100" style="display:none; animation: slideInRight 0.5s ease-out;">
        <div id="teacher-info" class="text-center mb-4 pb-4 border-b border-blue-200"></div>
        <div class="bg-gradient-to-r from-blue-500 to-indigo-500 rounded-xl p-4 mb-4 text-white shadow-lg">
            <h4 class="text-sm font-semibold mb-2 flex items-center gap-2">
                <span>ğŸ“ˆ</span>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…
            </h4>
            <div class="grid grid-cols-2 gap-2 text-center">
                <div class="bg-white bg-opacity-20 rounded-lg p-2">
                    <p class="text-2xl font-bold" id="today-operations">0</p>
                    <p class="text-xs opacity-90">Ø¹Ù…Ù„ÙŠØ©</p>
                </div>
                <div class="bg-white bg-opacity-20 rounded-lg p-2">
                    <p class="text-2xl font-bold" id="today-students">0</p>
                    <p class="text-xs opacity-90">Ø·Ø§Ù„Ø¨</p>
                </div>
            </div>
        </div>
        <h3 class="text-xl font-bold mb-3 text-gray-700 border-b pb-2 flex items-center gap-2">
            <span>â±ï¸</span>Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
        </h3>
        <div id="teacher-logs" class="space-y-2 text-sm max-h-96 overflow-y-auto pr-2">
            <div class="text-center py-4"><div class="loading-spinner"></div></div>
        </div>
    </div>

  <!-- Celebration Banner -->
  <div id="celebration-banner" class="fixed top-6 left-1/2 -translate-x-1/2 hidden z-[260]">
    <div id="celebration-inner" class="px-6 py-3 rounded-2xl shadow-2xl text-white font-bold flex items-center gap-3">
      <span id="celebration-emoji">ğŸ†</span>
      <span id="celebration-text">ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø©!</span>
    </div>
  </div>
  <!-- Modal ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù‚Ø§Ø· ÙŠØ¯ÙˆÙŠØ§Ù‹ -->
  <div id="manual-score-modal" class="fixed inset-0 z-[220] bg-black bg-opacity-60 hidden items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-5">
      <div class="flex justify-between items-center mb-3 border-b pb-2">
        <h3 class="text-lg font-bold text-gray-800">ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù‚Ø§Ø· ÙŠØ¯ÙˆÙŠØ§Ù‹</h3>
        <button onclick="closeManualScoreModal()" class="text-gray-400 hover:text-gray-600">Ã—</button>
      </div>
      <div class="space-y-4">
        <p class="text-gray-700">Ø§ÙƒØªØ¨ Ù…Ø¬Ù…ÙˆØ¹ Ù†Ù‚Ø§Ø· Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø·Ø§Ù„Ø¨ <span id="manual-score-student-name" class="font-semibold text-indigo-700"></span>.</p>
        <div class="flex items-center gap-2">
          <button class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded border" onmousedown="startRepeat(-1)" onmouseup="stopRepeat()" onmouseleave="stopRepeat()" ontouchstart="startRepeat(-1)" ontouchend="stopRepeat()">âˆ’</button>
          <input type="number" id="manual-score-input" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-center" placeholder="Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯">
          <button class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded border" onmousedown="startRepeat(1)" onmouseup="stopRepeat()" onmouseleave="stopRepeat()" ontouchstart="startRepeat(1)" ontouchend="stopRepeat()">+</button>
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
          <input type="text" id="manual-score-note" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ø³Ø¨Ø¨ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„...">
        </div>
        <div class="flex justify-end gap-2">
          <button onclick="submitManualScore()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Ø­ÙØ¸</button>
          <button onclick="closeManualScoreModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>
    </div>
  </div>

    <div class="flex-grow">
        <div class="bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 rounded-2xl p-8 mb-6 shadow-2xl text-white relative overflow-hidden">
            <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-5 rounded-full -mr-32 -mt-32"></div>
            <div class="absolute bottom-0 left-0 w-48 h-48 bg-white opacity-5 rounded-full -ml-24 -mb-24"></div>
            <div class="relative z-10 text-center">
                <div class="flex items-center justify-center gap-4 mb-3">
                    <span class="text-6xl">ğŸ“</span>
                    <h1 class="text-4xl font-extrabold">Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© ÙƒÙØ§Ø¡Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</h1>
                    <span class="text-6xl">ğŸ“Š</span>
                </div>
                <p class="text-blue-100 text-lg">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ</p>
                <p class="text-blue-100 text-lg">Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù„ØªØªØ¨Ø¹ ÙˆØªÙ‚ÙŠÙŠÙ… Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¨ÙƒÙØ§Ø¡Ø© Ø¹Ø§Ù„ÙŠØ©</p>
            </div>
        </div>

        <div id="steps-container">
            <div id="teachers-section">
                <h2 class="text-2xl font-semibold mb-4 text-blue-600">Ø§Ø®ØªØ± Ø­Ø³Ø§Ø¨Ùƒ:</h2>
                <div id="teachers" class="grid grid-cols-2 md:grid-cols-4 gap-6"></div>
            </div>

            <div id="subjects-section" style="display:none;">
                <button onclick="goBack('teachers-section')" class="mb-4 text-blue-500 hover:text-blue-700 flex items-center font-semibold">â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¹Ù„Ù…</button>
                <h2 class="text-2xl font-semibold mb-4 text-blue-600">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©: <span id="teacher-name-display" class="font-normal text-lg"></span></h2>
                <div id="subjects" class="grid grid-cols-2 md:grid-cols-4 gap-6"></div>
            </div>

            <div id="classes-section" style="display:none;">
                <button onclick="goBack('subjects-section')" class="mb-4 text-blue-500 hover:text-blue-700 flex items-center font-semibold">â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø¯Ø©</button>
                <h2 class="text-2xl font-semibold mb-4 text-blue-600">Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ù„Ù…Ø§Ø¯Ø© <span id="subject-name-display" class="font-normal text-lg"></span>:</h2>
                <div id="classes" class="grid grid-cols-2 md:grid-cols-4 gap-6"></div>
            </div>

            <div id="students-section" style="display:none;">
                <button onclick="goBack('classes-section')" class="mb-4 text-blue-500 hover:text-blue-700 flex items-center font-semibold">â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ</button>
                <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-4 mb-4 shadow-md">
                    <div class="grid grid-cols-4 gap-4 text-center">
                        <div>
                            <p class="text-gray-600 text-sm">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</p>
                            <p class="text-2xl font-bold text-purple-600" id="total-students-count">0</p>
                        </div>
                        <div>
                            <p class="text-gray-600 text-sm">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù†Ù‚Ø§Ø·</p>
                            <p class="text-2xl font-bold text-blue-600" id="average-score">0</p>
                        </div>
                        <div>
                            <p class="text-gray-600 text-sm">Ø£Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø·</p>
                            <p class="text-2xl font-bold text-green-600" id="highest-score">0</p>
                        </div>
                        <div>
                            <button onclick="showAllClassesStats()" class="px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-lg hover:shadow-lg transition-all transform hover:scale-105 ripple font-semibold">
                                ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ
                            </button>
                        </div>
                    </div>
                </div>
                <div class="flex justify-between items-center mb-4">
                    
                    <h2 class="text-2xl font-semibold text-blue-600">Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„ØµÙ <span id="class-name-display" class="font-normal text-lg"></span>:</h2>
                    <div class="flex gap-2">
                        <input type="text" id="student-search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨..." class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-64" oninput="searchStudents(this.value)">
                        <button onclick="sortStudents('name')" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition" title="ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù…">ğŸ“</button>
                        <button onclick="sortStudents('score')" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition" title="ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·">ğŸ†</button>
                    </div>
                </div>
                <div id="note-panel" class="hidden mb-4">
                    <div class="bg-white border border-blue-200 rounded-xl shadow p-4">
                        <div class="flex items-center justify-between mb-2">
                            <p class="text-sm text-gray-600">Ø£Ø¯Ø®Ù„ Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø·Ø§Ù„Ø¨ <strong class="text-indigo-700" id="note-student-name"></strong> (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</p>
                            <button onclick="closeNotePanel()" class="text-gray-400 hover:text-gray-600">Ã—</button>
                        </div>
                        <div class="flex items-start gap-3">
                            <textarea id="note-input" rows="2" class="flex-grow px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ù†Ø§..."></textarea>
                            <div class="flex gap-2">
                                <button onclick="submitNotePanel()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Ø­ÙØ¸</button>
                                <button onclick="closeNotePanel()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">Ø¥Ù„ØºØ§Ø¡</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="students" class="grid grid-cols-2 md:grid-cols-4 gap-6"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal ØªØ¹Ø¯ÙŠÙ„ Ù…Ù„Ø§Ø­Ø¸Ø© -->
<div id="note-edit-modal" class="fixed inset-0 z-[200] bg-black bg-opacity-60 hidden items-center justify-center p-4">
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-5">
    <div class="flex justify-between items-center mb-3 border-b pb-2">
      <h3 id="note-modal-title" class="text-lg font-bold text-gray-800">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</h3>
      <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">Ã—</button>
    </div>
    <div class="space-y-3">
      <textarea id="note-edit-text" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©..."></textarea>
      <div class="flex justify-end gap-2">
        <button onclick="submitNoteOrEdit()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Ø­ÙØ¸</button>
        <button onclick="closeEditModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>
  </div>

  <!-- Modal ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù -->
  <div id="confirm-delete-modal" class="fixed inset-0 z-[210] bg-black bg-opacity-60 hidden items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-5">
      <div class="flex justify-between items-center mb-3 border-b pb-2">
        <h3 class="text-lg font-bold text-gray-800">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
        <button onclick="cancelDeleteLog()" class="text-gray-400 hover:text-gray-600">Ã—</button>
      </div>
      <div class="space-y-4">
        <p class="text-gray-700">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.</p>
        <div class="flex justify-end gap-2">
          <button onclick="confirmDeleteLog()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">ØªØ£ÙƒÙŠØ¯</button>
          <button onclick="cancelDeleteLog()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>
    </div>
  </div>
<!-- Global Loading Overlay (unused now; kept for fallback) -->
<div id="global-loading" style="display:none"></div>

<!-- Image Viewer Modal -->
<div id="image-viewer" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-[300]" onclick="if(event.target.id==='image-viewer') closeImageModal()">
  <img id="image-viewer-img" src="" class="max-w-[90vw] max-h-[90vh] rounded-xl shadow-2xl" />
</div>

<footer class="mt-12 py-6 bg-gradient-to-r from-gray-800 to-gray-900 text-white text-center rounded-t-3xl shadow-2xl" style="display:none">
    <div class="container mx-auto">
        <p class="text-lg font-semibold mb-2">ğŸ“ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ÙƒÙØ§Ø¡Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</p>
        <p class="text-sm text-gray-400">ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ 2026-2027</p>
    </div>
</footer>

<!-- Modal Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ -->
<div id="all-classes-stats-modal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden">
        <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-6 text-white">
            <div class="flex justify-between items-center">
                <h3 class="text-3xl font-bold">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</h3>
                <button onclick="closeAllClassesModal()" class="text-white hover:bg-white hover:bg-opacity-20 w-10 h-10 rounded-full flex items-center justify-center text-2xl transition-all">Ã—</button>
            </div>
        </div>
        <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
            <div id="all-classes-content"></div>
        </div>
    </div>
</div>

<!-- Modal Ø³Ø¬Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨ -->
<div id="student-log-modal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden" onclick="if(event.target.id==='student-log-modal') closeModal()">
    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col">
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 text-white relative overflow-hidden flex-shrink-0">
            <div class="absolute top-0 left-0 w-full h-full opacity-10">
                <div class="absolute top-4 right-4 w-32 h-32 bg-white rounded-full"></div>
                <div class="absolute bottom-4 left-4 w-24 h-24 bg-white rounded-full"></div>
            </div>
            <div class="relative flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center">
                        <img id="modal-student-photo" src="" class="w-14 h-14 rounded-full object-cover" onclick="openImageModal(this.src)">
                    </div>
                    <div>
                        <h3 class="text-3xl font-bold" id="modal-student-name"></h3>
                        <p class="text-blue-100 text-sm" id="modal-student-class"></p>
                    </div>
                </div>
                <button onclick="closeModal()" class="text-white hover:bg-white hover:bg-opacity-20 w-10 h-10 rounded-full flex items-center justify-center text-2xl transition-all">Ã—</button>
            </div>
        </div>

        <div class="p-6 bg-white bg-opacity-90 flex-grow overflow-y-auto">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="stat-card bg-white rounded-xl p-4 shadow-lg border-r-4 border-blue-500 transform hover:scale-105 transition-all">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm mb-1">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</p>
                            <p class="text-3xl font-bold text-blue-600" id="modal-total-score">0</p>
                        </div>
                        <div class="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center"><span class="text-2xl">ğŸ†</span></div>
                    </div>
                </div>
                <div class="stat-card bg-white rounded-xl p-4 shadow-lg border-r-4 border-green-500 transform hover:scale-105 transition-all">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm mb-1">Ù†Ù‚Ø§Ø· Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©</p>
                            <p class="text-3xl font-bold text-green-600" id="modal-positive-score">0</p>
                        </div>
                        <div class="bg-green-100 w-12 h-12 rounded-full flex items-center justify-center"><span class="text-2xl">âœ¨</span></div>
                    </div>
                </div>
                <div class="stat-card bg-white rounded-xl p-4 shadow-lg border-r-4 border-red-500 transform hover:scale-105 transition-all">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm mb-1">Ù†Ù‚Ø§Ø· Ø³Ù„Ø¨ÙŠØ©</p>
                            <p class="text-3xl font-bold text-red-600" id="modal-negative-score">0</p>
                        </div>
                        <div class="bg-red-100 w-12 h-12 rounded-full flex items-center justify-center"><span class="text-2xl">âš ï¸</span></div>
                    </div>
                </div>
                <div class="stat-card bg-white rounded-xl p-4 shadow-lg border-r-4 border-purple-500 transform hover:scale-105 transition-all">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm mb-1">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</p>
                            <p class="text-3xl font-bold text-purple-600" id="modal-operations-count">0</p>
                        </div>
                        <div class="bg-purple-100 w-12 h-12 rounded-full flex items-center justify-center"><span class="text-2xl">ğŸ“Š</span></div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl p-5 shadow-lg mb-6">
                <h4 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <span>ğŸ“š</span>Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø§Ø¯Ø©
                </h4>
                <div id="modal-subject-stats" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
            </div>

            <div class="bg-white rounded-xl p-5 shadow-lg">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <span>ğŸ“œ</span>Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª
                    </h4>
                    <div class="flex gap-2">
                        <button onclick="filterLogs('all')" class="px-3 py-1 text-sm rounded-full bg-blue-500 text-white transition" id="filter-all">Ø§Ù„ÙƒÙ„</button>
                        <button onclick="filterLogs('positive')" class="px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-green-200 transition" id="filter-positive">Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©</button>
                        <button onclick="filterLogs('negative')" class="px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-red-200 transition" id="filter-negative">Ø³Ù„Ø¨ÙŠØ©</button>
                    </div>
                </div>
                
                <div id="modal-log-content" class="space-y-3 pr-2">
                    <p class="text-gray-500 text-center py-8">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„...</p>
                </div>
            </div>
        </div>

        <div class="bg-gray-50 p-4 flex justify-end gap-3 border-t flex-shrink-0">
            <button onclick="printStudentReport()" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition flex items-center gap-2 ripple">
                <span>ğŸ–¨ï¸</span>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            </button>
            <button onclick="closeModal()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>
</div>

<!-- Modal ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="login-password-modal" class="hidden fixed inset-0 z-[100] bg-black bg-opacity-80 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all">
        <div class="flex justify-between items-center mb-4 border-b pb-3">
            <h3 class="text-xl font-bold text-gray-800">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
            <button onclick="closeLoginPasswordModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <p class="text-gray-600 mb-4">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ ÙŠØ§ <strong id="teacher-name-in-modal" class="text-indigo-600">Ø§Ù„Ù…Ø¹Ù„Ù…</strong> Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©:</p>
        
        <div class="mb-4">
            <label for="teacher-password-input" class="block text-sm font-medium text-gray-700 mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
            
            <div class="relative">
                <input type="password" 
                       id="teacher-password-input" 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 text-right pr-10" 
                       placeholder="********"
                       onkeydown="if(event.key === 'Enter') verifyTeacherLoginFromModal()">
                
                <button type="button" 
                        id="toggle-password" 
                        onclick="togglePasswordVisibility()"
                        class="absolute top-1/2 left-3 transform -translate-y-1/2 text-gray-400 hover:text-gray-700 p-1">
                    
                    <svg id="eye-open-icon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                    
                    <svg id="eye-closed-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.014 10.014 0 0112 19c-4.477 0-8.268-2.943-9.542-7a9.97 9.97 0 011.026-1.574m9.096-7.852A9.974 9.974 0 0112 5c4.477 0 8.268 2.943 9.542 7a10.025 10.025 0 01-1.637 2.158m-2.859-4.708a3 3 0 11-4.242 4.242M1.45 1.45l21 21"></path></svg>
                </button>
            </div>
            <p id="login-error-message" class="text-sm text-red-500 mt-2 hidden">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p>
        </div>
        
        <div class="flex justify-end">
            <button onclick="verifyTeacherLoginFromModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150">
                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            </button>
        </div>
    </div>
</div>

<script>
// ======================================================
// â­ Ø±Ø§Ø¨Ø· ØªØ·Ø¨ÙŠÙ‚ Google Apps Script
// ======================================================
const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzbDdnKVeuRJ1-mqv7cb6wm6g_NTFby4X8wkvscX8qY5uAdxqG0UpWEx6B6GkXhGP_y/exec";

// ======================================================
// â­ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¹Ù„ÙˆÙŠ
// ======================================================
function topProgressStart(){
    const bar = document.getElementById('top-progress');
    if (!bar) return;
    bar.style.transition = 'width .3s ease, opacity .3s ease';
    bar.style.opacity = '1';
    bar.style.width = '8%';
    setTimeout(()=>{ bar.style.width = '55%'; }, 50);
}
function topProgressTo(p){
    const bar = document.getElementById('top-progress');
    if (!bar) return;
    bar.style.width = `${Math.max(0, Math.min(100, p))}%`;
}
function topProgressDone(){
    const bar = document.getElementById('top-progress');
    if (!bar) return;
    bar.style.width = '100%';
    setTimeout(()=>{ bar.style.opacity = '0'; bar.style.width = '0%'; }, 400);
}

// ======================================================
// â­ Ø¯ÙˆØ§Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
// ======================================================

/**
 * Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯ÙˆØ§Ù„ Google Apps Script
 */
async function callGAS(functionName, args, successHandler, failureHandler) {
    try {
        const payload = {
            functionName: functionName,
            args: args
        };

        console.log("ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¥Ù„Ù‰:", functionName, args);

        const response = await fetch(GAS_WEB_APP_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'text/plain;charset=utf-8',
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            throw new Error(`Ø®Ø·Ø£ HTTP: ${response.status}`);
        }
        const text = await response.text();
        console.log("ğŸ“¥ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø®Ø§Ù…:", text);

        let data;
        try {
            data = JSON.parse(text);
        } catch (e) {
            throw new Error("Ø±Ø¯ ØºÙŠØ± ØµØ§Ù„Ø­: " + text);
        }

        if (data.success === false) {
            failureHandler(data.error || "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ");
        } else {
            successHandler(data.data || data);
        }

    } catch (e) {
        console.error("âŒ ÙØ´Ù„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ GAS:", e);
        failureHandler(e.message || "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….");
    }
}

// ======================================================
// â­ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù‚Ø§Ø· ÙŠØ¯ÙˆÙŠØ§Ù‹ (Ù†Ø·Ø§Ù‚ Ø¹Ø§Ù…)
// ======================================================
let __manualTarget = { id: null, name: null, current: 0 };
function openManualScoreModal(studentID, studentName, currentScore){
    __manualTarget = { id: studentID, name: studentName, current: Number(currentScore) || 0 };
    const nameEl = document.getElementById('manual-score-student-name');
    const input = document.getElementById('manual-score-input');
    if (nameEl) nameEl.textContent = studentName;
    if (input) { input.value = __manualTarget.current; setTimeout(()=>input.focus(), 0); }
    const modal = document.getElementById('manual-score-modal');
    if (modal){ modal.classList.remove('hidden'); modal.classList.add('flex'); }
}
function closeManualScoreModal(){
    const modal = document.getElementById('manual-score-modal');
    if (modal){ modal.classList.add('hidden'); modal.classList.remove('flex'); }
    __manualTarget = { id: null, name: null, current: 0 };
}
function submitManualScore(){
    const input = document.getElementById('manual-score-input');
    const noteEl = document.getElementById('manual-score-note');
    if (!input || __manualTarget.id == null) { closeManualScoreModal(); return; }
    const newTotal = Number(input.value);
    if (Number.isNaN(newTotal)) { showNotification('âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­', 'error'); return; }
    const delta = Math.round(newTotal - (__manualTarget.current || 0));
    if (delta === 0) { closeManualScoreModal(); return; }
    const studentID = __manualTarget.id;
    const studentName = __manualTarget.name || '';
    const noteText = noteEl && noteEl.value ? `ØªØ¹ÙŠÙŠÙ† ÙŠØ¯ÙˆÙŠ: ${noteEl.value}` : 'ØªØ¹ÙŠÙŠÙ† ÙŠØ¯ÙˆÙŠ';
    closeManualScoreModal();
    callGAS('recordBehavior', [studentID, currentTeacher.TeacherID, currentSubject, delta, noteText], (res)=>{
        if (res && res.success) {
            showNotification('âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            showCelebration(delta, studentName);
            const scoreElement = document.getElementById(`score-${studentID}`);
            if (scoreElement) scoreElement.textContent = res.newTotal;
            clearCache(`students:${currentClass || 'none'}`);
            loadStudents();
            loadTeacherLogs();
        } else {
            showNotification(`âŒ ÙØ´Ù„ Ø§Ù„ØªØ¹ÙŠÙŠÙ†: ${(res && res.message) ? res.message : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`, 'error');
        }
    }, (err)=>{
        showNotification(`âŒ ÙØ´Ù„ Ø§Ù„ØªØ¹ÙŠÙŠÙ†: ${err}`, 'error');
    });
}
let __repeatTimer = null;
let __repeatDelta = 0;
function startRepeat(delta){
    __repeatDelta = delta;
    stepManual(delta);
    if (__repeatTimer) clearInterval(__repeatTimer);
    __repeatTimer = setInterval(()=> stepManual(__repeatDelta), 120);
}
function stopRepeat(){
    if (__repeatTimer) { clearInterval(__repeatTimer); __repeatTimer = null; }
}
function stepManual(delta){
    const input = document.getElementById('manual-score-input');
    if (!input) return;
    const v = Number(input.value || __manualTarget.current || 0);
    const next = (Number.isNaN(v) ? 0 : v) + delta;
    input.value = next;
}
// expose to window for inline handlers
window.openManualScoreModal = openManualScoreModal;
window.closeManualScoreModal = closeManualScoreModal;
window.submitManualScore = submitManualScore;
window.startRepeat = startRepeat;
window.stopRepeat = stopRepeat;

// ======================================================
// â­ Ø´Ø±ÙŠØ· Ø§Ø­ØªÙØ§Ù„ Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ©/Ø®ØµÙ… Ù†Ù‚Ø§Ø·
// ======================================================
function showCelebration(delta, name){
    try {
        const banner = document.getElementById('celebration-banner');
        const inner = document.getElementById('celebration-inner');
        const emoji = document.getElementById('celebration-emoji');
        const text = document.getElementById('celebration-text');
        if (!banner || !inner || !emoji || !text) return;
        const positive = Number(delta) > 0;
        inner.className = `px-6 py-3 rounded-2xl shadow-2xl text-white font-bold flex items-center gap-3 ${positive ? 'bg-green-600' : 'bg-red-600'}`;
        emoji.textContent = positive ? 'ğŸ†' : 'âš ï¸';
        const who = name ? ` Ù„Ù„Ø·Ø§Ù„Ø¨ ${name}` : '';
        text.textContent = positive ? `ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø©${who}!` : `ØªÙ… Ø®ØµÙ… Ù†Ù‚Ø·Ø©${who}.`;
        banner.classList.remove('hidden');
        banner.style.opacity = '1';
        banner.style.transform = 'translate(-50%, 0)';
        setTimeout(()=>{
            banner.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
            banner.style.opacity = '0';
            banner.style.transform = 'translate(-50%, -20px)';
            setTimeout(()=>{
                banner.classList.add('hidden');
                banner.style.transition = 'none';
                banner.style.opacity = '1';
                banner.style.transform = 'translate(-50%, 0)';
            }, 450);
        }, 1200);
    } catch(e){
        console.warn('celebration error', e);
    }
}

// ======================================================
// â­ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø§Ù…Ø©
// ======================================================
let __loaderTimer = null;
let __progressTimer = null;
function showLoading() {
    const bar = document.getElementById('top-progress');
    if (!bar) return;
    if (__loaderTimer) clearTimeout(__loaderTimer);
    if (__progressTimer) clearTimeout(__progressTimer);
    // Ø¨Ø¯Ø¡ Ø¨Ø´Ø±ÙŠØ· Ø³Ø±ÙŠØ¹ ØºÙŠØ± Ø­Ø§Ø¬Ø¨ØŒ Ù…Ø¹ ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„ÙˆÙ…ÙŠØ¶
    __loaderTimer = setTimeout(() => {
        bar.style.transition = 'width 0.2s ease';
        bar.style.width = '30%';
        // ØªÙ‚Ø¯Ù‘Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¥Ù„Ù‰ 70% Ø¥Ø°Ø§ Ø·Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
        __progressTimer = setTimeout(()=>{
            bar.style.transition = 'width 0.6s ease';
            bar.style.width = '70%';
        }, 300);
    }, 150);
}
function hideLoading() {
    const bar = document.getElementById('top-progress');
    if (!bar) return;
    if (__loaderTimer) { clearTimeout(__loaderTimer); __loaderTimer = null; }
    if (__progressTimer) { clearTimeout(__progressTimer); __progressTimer = null; }
    // Ø£Ù†Ù‡Ù Ø¥Ù„Ù‰ 100% Ø«Ù… ØµÙÙ‘Ø± Ø¨Ø³Ø±Ø¹Ø©
    bar.style.transition = 'width 0.2s ease';
    bar.style.width = '100%';
    setTimeout(()=>{
        bar.style.transition = 'none';
        bar.style.width = '0%';
    }, 200);
}

// ======================================================
// â­ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
// ======================================================
let currentTeacher = null;
let currentSubject = null;
let currentSubjectName = null;
let currentClass = null;
let currentClassName = null;
let currentStudentData = null;
let currentFilteredLogs = [];
let allStudentsData = [];
let pendingTeacherName = null;
let allClassesStats = [];
let pendingStudentId = null;
let pendingStudentName = null;
let pendingChangeValue = null;
let currentEditLogId = null;
let noteModalMode = null; // 'add' | 'edit'
const CACHE_TTL_MS = 5 * 60 * 1000; // 5 Ø¯Ù‚Ø§Ø¦Ù‚

// ======================================================
// â­ Ø¯ÙˆØ§Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
// ======================================================

function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500', warning: 'bg-yellow-500' };
    const icons = { success: 'âœ…', error: 'âŒ', info: 'â„¹ï¸', warning: 'âš ï¸' };
    notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 ${colors[type]} text-white px-6 py-4 rounded-lg shadow-2xl z-50 flex items-center gap-3`;
    notification.style.animation = 'slideDown 0.3s ease-out';
    notification.innerHTML = `<span class="text-2xl">${icons[type]}</span><span class="font-semibold">${message}</span>`;
    document.body.appendChild(notification);
    setTimeout(() => {
        notification.style.animation = 'slideUp 0.3s ease-out forwards';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

function showSection(sectionId) {
    document.querySelectorAll('#steps-container > div').forEach(div => div.style.display = 'none');
    document.getElementById(sectionId).style.display = 'block';
}

function goBack(sectionId) {
    if (sectionId === 'teachers-section') {
        currentTeacher = null;
        document.getElementById('sidebar').style.display = 'none';
        document.getElementById('teacher-info').innerHTML = '';
        loadTeachers();
    } else if (sectionId === 'subjects-section') {
        currentSubject = null;
        currentSubjectName = null;
    } else if (sectionId === 'classes-section') {
        currentClass = null;
        currentClassName = null;
    }
    showSection(sectionId);
}

// ======================================================
// â­ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
// ======================================================

function loadTeachers() {
    callGAS('getTeachers', [], renderTeachers, (err) => {
        console.error(err);
        showNotification("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†: " + err, "error");
        document.getElementById('teachers').innerHTML = `<p class="col-span-4 text-center text-red-500">ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…: ${err}</p>`;
    });
}

function renderTeachers(data) {
    const container = document.getElementById('teachers');
    container.innerHTML = '';
    
    if (data.length === 0) {
        container.innerHTML = `<p class="col-span-4 text-center text-red-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹Ù„Ù…ÙŠÙ† Ù„Ø¹Ø±Ø¶Ù‡Ø§.</p>`;
        return;
    }
    
    data.forEach((t, index) => {
        const div = document.createElement('div');
        div.className = 'card card-hover-effect';
        div.style.animation = `fadeIn 0.5s ease-out ${index * 0.1}s both`;
        div.innerHTML = `
            <div class="relative">
                <img loading="lazy" src="${t.PhotoURL || 'https://via.placeholder.com/100'}" class="avatar mb-3 shadow-lg" onclick="openImageModal('${t.PhotoURL || 'https://via.placeholder.com/100'}')">
                <h3 class="text-xl font-bold text-gray-700 mt-3">${t.TeacherName}</h3>
                <div class="mt-3 pt-3 border-t border-gray-200">
                    <button class="w-full bg-gradient-to-r from-blue-500 to-indigo-500 text-white py-2 rounded-lg hover:shadow-lg transition-all transform hover:scale-105 ripple">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                </div>
            </div>
        `;
        div.onclick = () => loginTeacher(t.TeacherName);
        container.appendChild(div);
    });
    showSection('teachers-section');
}

// ======================================================
// â­ Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
// ======================================================

function loginTeacher(name) {
    openLoginPasswordModal(name);
}

function openLoginPasswordModal(teacherName) {
    pendingTeacherName = teacherName;
    document.getElementById('teacher-name-in-modal').textContent = teacherName;
    const modal = document.getElementById('login-password-modal');
    modal.classList.remove('hidden');
    document.getElementById('teacher-password-input').value = '';
    document.getElementById('login-error-message').classList.add('hidden');
    document.getElementById('teacher-password-input').focus();
}

function closeLoginPasswordModal() {
    document.getElementById('login-password-modal').classList.add('hidden');
}

function togglePasswordVisibility() {
    const passwordInput = document.getElementById('teacher-password-input');
    const eyeOpen = document.getElementById('eye-open-icon');
    const eyeClosed = document.getElementById('eye-closed-icon');

    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        eyeOpen.classList.remove('hidden');
        eyeClosed.classList.add('hidden');
    } else {
        passwordInput.type = 'password';
        eyeOpen.classList.add('hidden');
        eyeClosed.classList.remove('hidden');
    }
}

function verifyTeacherLoginFromModal() {
    const name = pendingTeacherName;
    const pass = document.getElementById('teacher-password-input').value;
    
    if (!pass || pass.trim() === "") {
        document.getElementById('login-error-message').textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±";
        document.getElementById('login-error-message').classList.remove('hidden');
        return;
    }

    closeLoginPasswordModal();
    document.getElementById('teachers').innerHTML = `<div class="col-span-4 text-center"><div class="loading-spinner"></div><p class="text-xl text-blue-500 mt-4">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±...</p></div>`;
    callGAS('verifyTeacher', [name, pass], 
        (res) => {
            if (res.success) {
                currentTeacher = res;
                document.getElementById('teacher-info').innerHTML = `
                    <div style="animation: fadeIn 0.5s ease-out">
                        <img src="${res.PhotoURL || 'https://via.placeholder.com/100'}" class="avatar mb-3">
                        <h3 class="text-xl font-bold">${res.TeacherName}</h3>
                        <p class="text-sm text-gray-500">Ø§Ù„Ù…ÙˆØ§Ø¯: ${res.Subjects.join(', ') || 'Ø§Ù„ÙƒÙ„'}</p>
                        <button onclick="logout()" class="mt-3 px-3 py-1 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                    </div>
                `;
                document.getElementById('sidebar').style.display = 'block';
                document.getElementById('teacher-name-display').textContent = res.TeacherName;
                showNotification(`Ù…Ø±Ø­Ø¨Ù‹Ø§ ${res.TeacherName} ğŸ‘‹`, "success");
                saveSessionToCache();
                loadSubjects(res.Subjects);
                loadTeacherLogs();
            } else {
                showNotification(`ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ${res.message || 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©'}`, "error");
                loadTeachers();
            }
        }, 
        (err) => {
            showNotification("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰", "error");
            loadTeachers();
        }
    );
}

// ======================================================
// â­ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„ØµÙÙˆÙ
// ======================================================

function loadSubjects(teacherSubjects) {
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ù† Ø§Ù„ÙƒØ§Ø´
    const cacheKey = `subjects:${(currentTeacher && currentTeacher.TeacherID) || 'unknown'}`;
    const cached = readCache(cacheKey);
    if (cached) {
        renderSubjects(cached);
        return;
    }
    callGAS('getTeacherAllowedSubjects', [teacherSubjects], (data)=>{
        writeCache(cacheKey, data);
        renderSubjects(data);
    }, (err) => {
        console.error(err);
        showNotification("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†: " + err, "error");
        document.getElementById('teachers').innerHTML = `<p class="col-span-4 text-center text-red-500">ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…: ${err}</p>`;
    });
}

function renderSubjects(data) {
    const container = document.getElementById('subjects');
    container.innerHTML = '';
    
    if (data.length === 0) {
        container.innerHTML = `<p class="col-span-4 text-center text-red-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ§Ø¯ Ù„Ø¹Ø±Ø¶Ù‡Ø§.</p>`;
        return;
    }
    
    data.forEach((s, index) => {
        const div = document.createElement('div');
        div.className = 'card card-hover-effect';
        div.style.animation = `fadeIn 0.5s ease-out ${index * 0.1}s both`;
        div.innerHTML = `
            <div class="relative">
                <img loading="lazy" src="${s.SubjectIconURL || 'https://via.placeholder.com/100'}" class="avatar mb-3 shadow-lg" onclick="openImageModal('${s.SubjectIconURL || 'https://via.placeholder.com/100'}')">
                <h3 class="text-xl font-bold text-gray-700 mt-3">${s.SubjectName}</h3>
                <p class="text-sm text-gray-500 mt-2">${s.SubjectID}</p>
                <div class="mt-3 pt-3 border-t border-gray-200">
                    <button class="w-full bg-gradient-to-r from-green-500 to-emerald-500 text-white py-2 rounded-lg hover:shadow-lg transition-all transform hover:scale-105 ripple">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø¯Ø©</button>
                </div>
            </div>
        `;
        div.onclick = () => selectSubject(s.SubjectName);
        // ØªÙ‡ÙŠØ¦Ø© Ø¬Ù„Ø¨ Ù…Ø³Ø¨Ù‚ Ù„Ù„ØµÙÙˆÙ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±ÙˆØ±
        div.onmouseenter = () => prefetchClasses(s.SubjectName);
        container.appendChild(div);
    });
    showSection('subjects-section');
}

function selectSubject(name) {
    currentSubject = name;
    currentSubjectName = name;
    document.getElementById('subject-name-display').textContent = name;
    saveSessionToCache();
    loadClasses();
}

function loadClasses() {
    const cacheKey = `classes:${currentSubject || 'none'}`;
    const cached = readCache(cacheKey);
    if (cached) { renderClasses(cached); return; }
    showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙÙˆÙ...');
    callGAS('getClassesBySubject', [currentSubject], (data) => {
        writeCache(cacheKey, data);
        renderClasses(data);
        hideLoading();
    }, (err) => {
        showNotification("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙÙˆÙ: " + err, "error");
        showSection('classes-section');
        hideLoading();
    });
}

function renderClasses(data){
    const container = document.getElementById('classes');
    container.innerHTML = '';
    if (data.length === 0) {
        container.innerHTML = `<p class="col-span-4 text-center text-red-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙˆÙ Ù…Ø®ØµØµØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø©.</p>`;
        showSection('classes-section');
        return;
    }
    data.forEach((c, index) => {
        const div = document.createElement('div');
        div.className = 'card';
        div.style.animation = `fadeIn 0.5s ease-out ${index * 0.1}s both`;
        div.innerHTML = `
            <div class="relative">
                <img loading="lazy" src="${c.PhotoURL || 'https://via.placeholder.com/100'}" class="avatar mb-3 shadow-lg" onclick="openImageModal('${c.PhotoURL || 'https://via.placeholder.com/100'}')">
                <h3 class="text-xl font-bold text-gray-700 mt-3">${c.ClassName}</h3>
                <p class="text-sm text-gray-500 mt-2">Ø§Ù„Ù‚Ø³Ù…: ${c.Section}</p>
                <div class="mt-3 pt-3 border-t border-gray-200">
                    <button class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-2 rounded-lg hover:shadow-lg transition-all transform hover:scale-105 ripple">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ</button>
                </div>
            </div>
        `;
        div.onclick = () => selectClass(c.ClassID, c.ClassName);
        // Ø¬Ù„Ø¨ Ù…Ø³Ø¨Ù‚ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±ÙˆØ±
        div.onmouseenter = () => prefetchStudents(c.ClassID);
        container.appendChild(div);
    });
    showSection('classes-section');
}

function selectClass(classID, className) {
    currentClass = classID;
    currentClassName = className;
    document.getElementById('class-name-display').textContent = className;
    saveSessionToCache();
    loadStudents();
}

// ======================================================
// â­ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
// ======================================================

function loadStudents() {
    const cacheKey = `students:${currentClass || 'none'}`;
    const cached = readCache(cacheKey);
    if (cached) { processStudents(cached); loadTeacherLogs(); return; }
    showLoading();
    callGAS('getStudentsByClass', [currentClass], (data) => { writeCache(cacheKey, data); processStudents(data); hideLoading(); }, (err) => {
        showNotification("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨: " + err, "error");
        hideLoading();
    });

    loadTeacherLogs();

    callGAS('getAllClassesStats', [currentSubject], (data) => {
        allClassesStats = data;
    }, (err) => {
        console.error("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ:", err);
    });
}

function processStudents(data) {
    allStudentsData = data;
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    document.getElementById('total-students-count').textContent = data.length;
    
    if (data.length > 0) {
        const totalScore = data.reduce((sum, student) => sum + student.TotalScore, 0);
        const averageScore = (totalScore / data.length).toFixed(1);
        const highestScore = Math.max(...data.map(student => student.TotalScore));
        
        document.getElementById('average-score').textContent = averageScore;
        document.getElementById('highest-score').textContent = highestScore;
    } else {
        document.getElementById('average-score').textContent = '0';
        document.getElementById('highest-score').textContent = '0';
    }
    
    renderStudentCards(data);
    showSection('students-section');
}

function renderStudentCards(students) {
    const container = document.getElementById('students');
    container.innerHTML = '';
    
    if (students.length === 0) {
        container.innerHTML = `<p class="col-span-4 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>`;
        return;
    }
    // Ø­Ø¯Ø¯ Ø£Ø¹Ù„Ù‰ 3 Ø­Ø³Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ© Ø¥Ù† ØªÙˆÙØ±ØªØŒ ÙˆØ¥Ù„Ø§ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ
    const getMetric = (s) => {
        if (typeof s.PositiveScore === 'number') return s.PositiveScore;
        if (typeof s.Positive === 'number') return s.Positive;
        return typeof s.TotalScore === 'number' ? s.TotalScore : 0;
    };
    const ranked = [...students].sort((a, b) => getMetric(b) - getMetric(a));
    const top3Ids = ranked.slice(0, 3).map(s => s.StudentID);
    const topIndex = new Map(top3Ids.map((id, idx) => [id, idx]));

    students.forEach((s, index) => {
        const div = document.createElement('div');
        div.className = 'card';
        div.style.animation = `fadeIn 0.3s ease-out ${index * 0.05}s both`;
        
        let rankBadge = '';
        if (topIndex.has(s.StudentID)) {
            const pos = topIndex.get(s.StudentID);
            if (pos === 0) rankBadge = '<div class="absolute top-2 left-2 bg-yellow-400 text-white px-2 py-1 rounded-full text-xs font-bold">ğŸ¥‡ Ø§Ù„Ø£ÙˆÙ„</div>';
            else if (pos === 1) rankBadge = '<div class="absolute top-2 left-2 bg-gray-300 text-white px-2 py-1 rounded-full text-xs font-bold">ğŸ¥ˆ Ø§Ù„Ø«Ø§Ù†ÙŠ</div>';
            else if (pos === 2) rankBadge = '<div class="absolute top-2 left-2 bg-orange-400 text-white px-2 py-1 rounded-full text-xs font-bold">ğŸ¥‰ Ø§Ù„Ø«Ø§Ù„Ø«</div>';
        }
        
        div.innerHTML = `
            <div class="relative">
                ${rankBadge}
                <div onclick="openStudentLogModal('${s.StudentID}', '${s.StudentName}')" class="cursor-pointer group">
                    <img loading="lazy" src="${s.PhotoURL || 'https://via.placeholder.com/100'}" class="avatar group-hover:scale-110 transition-transform duration-300" onclick="event.stopPropagation(); openImageModal('${s.PhotoURL || 'https://via.placeholder.com/100'}')">
                    <h3 class="mt-3 text-lg font-bold text-gray-700 group-hover:text-blue-600 transition-colors">${s.StudentName}</h3>
                    <p class="text-xs text-gray-500 mt-1">Ø§Ø¶ØºØ· Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ÙƒØ§Ù…Ù„ ğŸ“Š</p>
                </div>
                <div class="mt-3 flex justify-around items-center bg-gradient-to-r from-gray-50 to-gray-100 p-3 rounded-xl shadow-inner">
                    <button onclick="changeScore('${s.StudentID}', 1, '${s.StudentName}')" class="bg-gradient-to-r from-green-500 to-emerald-500 text-white w-10 h-10 rounded-full text-xl hover:scale-110 hover:shadow-lg transition-all transform active:scale-95 ripple">â•</button>
                    <span id="score-${s.StudentID}" class="text-3xl font-extrabold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">${s.TotalScore}</span>
                    <button onclick="changeScore('${s.StudentID}', -1, '${s.StudentName}')" class="bg-gradient-to-r from-red-500 to-rose-500 text-white w-10 h-10 rounded-full text-xl hover:scale-110 hover:shadow-lg transition-all transform active:scale-95 ripple">â–</button>
                </div>
                <div class="mt-2 text-center">
                    <button onclick="event.stopPropagation(); openManualScoreModal('${s.StudentID}', decodeURIComponent('${encodeURIComponent(s.StudentName)}'), ${s.TotalScore})" class="px-2 py-1 text-xs rounded bg-gray-100 hover:bg-gray-200 text-gray-700 border">ØªØ¹ÙŠÙŠÙ† ÙŠØ¯ÙˆÙŠ</button>
                </div>
            </div>
        `;
        container.appendChild(div);
    });
}

function searchStudents(query) {
    const searchTerm = query.trim().toLowerCase();
    const filtered = allStudentsData.filter(s => s.StudentName.toLowerCase().includes(searchTerm));
    renderStudentCards(filtered);
}

function sortStudents(type) {
    let sorted = [...allStudentsData];
    if (type === 'name') {
        sorted.sort((a, b) => a.StudentName.localeCompare(b.StudentName, 'ar'));
    } else if (type === 'score') {
        sorted.sort((a, b) => b.TotalScore - a.TotalScore);
    }
    renderStudentCards(sorted);
}

// ======================================================
// â­ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ù‚Ø§Ø·
// ======================================================

function changeScore(studentID, changeValue, studentName) {
    pendingStudentId = studentID;
    pendingStudentName = studentName;
    pendingChangeValue = changeValue;
    const isPositive = changeValue > 0;
    const title = isPositive ? `Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø© - ${studentName}` : `Ø®ØµÙ… Ù†Ù‚Ø·Ø© - ${studentName}`;
    openNoteModalForAction(title, '');
}

// Ù„Ù… Ù†Ø¹Ø¯ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©ØŒ Ø§Ø³ØªÙØ¨Ø¯Ù„Øª Ø¨Ù†Ø§ÙØ°Ø© Ù…ÙˆØ­Ø¯Ø©
function openNotePanel(){}
function closeNotePanel(){}
function submitNotePanel(){}

function openNoteModalForAction(title, prefill){
    noteModalMode = 'add';
    const modal = document.getElementById('note-edit-modal');
    const textarea = document.getElementById('note-edit-text');
    const titleEl = document.getElementById('note-modal-title');
    if (titleEl) titleEl.textContent = title || 'Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø©';
    if (textarea) textarea.value = prefill || '';
    if (modal){ modal.classList.remove('hidden'); modal.classList.add('flex'); }
    if (textarea) textarea.focus();
}

// ======================================================
// â­ Ø³Ø¬Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨
// ======================================================

function openStudentLogModal(studentID, studentName) {
    currentStudentData = allStudentsData.find(s => s.StudentID === studentID);
    
    document.getElementById('modal-student-name').textContent = studentName;
    document.getElementById('modal-student-class').textContent = currentClassName;
    document.getElementById('modal-student-photo').src = currentStudentData.PhotoURL || 'https://via.placeholder.com/100';
    document.getElementById('modal-total-score').textContent = currentStudentData.TotalScore;
    
    document.getElementById('modal-log-content').innerHTML = '<p class="text-gray-500 text-center py-8">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„...</p>';
    
    showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„...');
    callGAS('getStudentLog', [studentID], (data)=>{ renderStudentLog(data); hideLoading(); }, (err) => {
        showNotification("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨: " + err, "error");
        document.getElementById('modal-log-content').innerHTML = `<p class="text-red-500 text-center py-8">ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ${err}</p>`;
        hideLoading();
    });
    
    document.getElementById('student-log-modal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('student-log-modal').classList.add('hidden');
}

function renderStudentLog(data) {
    currentFilteredLogs = data;
    
    if (data.length === 0) {
        document.getElementById('modal-log-content').innerHTML = '<p class="text-center text-gray-500 py-8">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù†Ù‚Ø§Ø· Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ø¹Ø¯.</p>';
        document.getElementById('modal-operations-count').textContent = '0';
        document.getElementById('modal-positive-score').textContent = '0';
        document.getElementById('modal-negative-score').textContent = '0';
        document.getElementById('modal-subject-stats').innerHTML = '<p class="col-span-2 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
        return;
    }
    
    let positiveTotal = 0;
    let negativeTotal = 0;
    const subjectStats = {};
    
    data.forEach(log => {
        if (log.Change > 0) {
            positiveTotal += log.Change;
        } else {
            negativeTotal += Math.abs(log.Change);
        }
        
        if (!subjectStats[log.Subject]) {
            subjectStats[log.Subject] = { positive: 0, negative: 0, total: 0, count: 0 };
        }
        subjectStats[log.Subject].count++;
        if (log.Change > 0) {
            subjectStats[log.Subject].positive += log.Change;
        } else {
            subjectStats[log.Subject].negative += Math.abs(log.Change);
        }
        subjectStats[log.Subject].total = subjectStats[log.Subject].positive - subjectStats[log.Subject].negative;
    });
    
    document.getElementById('modal-operations-count').textContent = data.length;
    document.getElementById('modal-positive-score').textContent = positiveTotal;
    document.getElementById('modal-negative-score').textContent = negativeTotal;
    
    const subjectStatsHTML = Object.entries(subjectStats).map(([subject, stats]) => {
        const totalOps = stats.positive + stats.negative;
        const percentage = totalOps > 0 ? ((stats.positive / totalOps) * 100).toFixed(0) : 0;
        const barColor = stats.total >= 0 ? 'bg-green-500' : 'bg-red-500';
        return `
            <div class="p-3 bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg border border-gray-200 hover:shadow-md transition-all">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-bold text-gray-800">${subject}</span>
                    <span class="text-sm px-2 py-1 rounded-full ${stats.total >= 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} font-semibold">${stats.total >= 0 ? '+' : ''}${stats.total}</span>
                </div>
                <div class="flex gap-2 text-xs mb-2">
                    <span class="text-green-600">âœ… ${stats.positive}</span>
                    <span class="text-red-600">âŒ ${stats.negative}</span>
                    <span class="text-gray-500">ğŸ“Š ${stats.count} Ø¹Ù…Ù„ÙŠØ©</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                    <div class="${barColor} h-full rounded-full transition-all" style="width: ${percentage}%"></div>
                </div>
            </div>
        `;
    }).join('');
    
    document.getElementById('modal-subject-stats').innerHTML = subjectStatsHTML || '<p class="col-span-2 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
    
    renderFilteredLogs(data);
}

function filterLogs(type) {
    document.querySelectorAll('[id^="filter-"]').forEach(btn => {
        btn.classList.remove('bg-blue-500', 'text-white');
        btn.classList.add('bg-gray-200');
    });
    document.getElementById(`filter-${type}`).classList.add('bg-blue-500', 'text-white');
    document.getElementById(`filter-${type}`).classList.remove('bg-gray-200');
    
    let filtered = currentFilteredLogs;
    if (type === 'positive') {
        filtered = currentFilteredLogs.filter(log => log.Change > 0);
    } else if (type === 'negative') {
        filtered = currentFilteredLogs.filter(log => log.Change < 0);
    }
    renderFilteredLogs(filtered);
}

function renderFilteredLogs(logs) {
    const container = document.getElementById('modal-log-content');
    if (logs.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500 py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø´Ø§Ø·Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.</p>';
        return;
    }
    
    const html = logs.map((log, index) => {
        const isPositive = log.Change > 0;
        const bgColor = isPositive ? 'bg-gradient-to-r from-green-50 to-emerald-50' : 'bg-gradient-to-r from-red-50 to-rose-50';
        const borderColor = isPositive ? 'border-r-4 border-green-500' : 'border-r-4 border-red-500';
        const textColor = isPositive ? 'text-green-700' : 'text-red-700';
        const icon = isPositive ? 'âœ…' : 'âŒ';
        const sign = isPositive ? '+' : '';
        
        let formattedDate;
        try {
            const date = new Date(log.Timestamp);
            if (!isNaN(date.getTime())) {
                formattedDate = date.toLocaleString('ar-EG', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } else {
                formattedDate = String(log.Timestamp);
            }
        } catch (e) {
            formattedDate = String(log.Timestamp);
        }
        
        return `
            <div class="relative ${bgColor} ${borderColor} rounded-xl p-4 shadow-md hover:shadow-lg transition-all transform hover:-translate-y-1" style="animation: slideIn 0.3s ease-out ${index * 0.05}s both">
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0 w-12 h-12 ${isPositive ? 'bg-green-500' : 'bg-red-500'} rounded-full flex items-center justify-center text-white text-xl shadow-lg">${icon}</div>
                    <div class="flex-grow">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="font-bold text-2xl ${textColor}">${sign}${log.Change}</span>
                                <span class="text-gray-600 text-sm mr-2">Ù†Ù‚Ø·Ø©</span>
                            </div>
                            <div class="text-left bg-white px-3 py-1 rounded-full shadow-sm">
                                <span class="font-semibold text-gray-700">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: </span>
                                <span class="font-bold ${log.NewTotal >= 0 ? 'text-blue-600' : 'text-red-600'}">${log.NewTotal}</span>
                            </div>
                        </div>
                        <div class="space-y-1">
                            <div class="flex items-center gap-2 text-sm text-gray-600">
                                <span class="font-semibold">ğŸ‘¨â€ğŸ« Ø§Ù„Ù…Ø¹Ù„Ù…:</span>
                                <span>${log.TeacherName}</span>
                            </div>
                            <div class="flex items-center gap-2 text-sm text-gray-600">
                                <span class="font-semibold">ğŸ“š Ø§Ù„Ù…Ø§Ø¯Ø©:</span>
                                <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-xs">${log.Subject}</span>
                            </div>
                            <div class="mt-2 p-2 bg-white bg-opacity-70 rounded-lg border-r-2 border-blue-400">
                                <span class="text-xs font-semibold text-blue-600">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø©:</span>
                                <p class="text-sm text-gray-700 mt-1">${log.Note || ''}</p>
                                <div class="mt-2 flex gap-2">
                                    <button class="px-2 py-1 text-xs rounded bg-yellow-100 text-yellow-800 hover:bg-yellow-200" onclick="openEditModal('${log.LogID}', decodeURIComponent('${encodeURIComponent(log.Note || '')}'))">ØªØ¹Ø¯ÙŠÙ„</button>
                                    <button class="px-2 py-1 text-xs rounded bg-red-100 text-red-800 hover:bg-red-200" onclick="deleteLogEntry('${log.LogID}')">Ø­Ø°Ù</button>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 flex items-center gap-2 text-xs text-gray-500">
                            <span>ğŸ•</span>
                            <span>${formattedDate}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    container.innerHTML = html;
}

// ======================================================
// â­ Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© ÙˆØ­Ø°Ù Ø§Ù„Ø³Ø¬Ù„
// ======================================================
function openEditModal(logId, currentNote) {
    noteModalMode = 'edit';
    currentEditLogId = logId;
    const modal = document.getElementById('note-edit-modal');
    const textarea = document.getElementById('note-edit-text');
    const titleEl = document.getElementById('note-modal-title');
    if (titleEl) titleEl.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©';
    if (textarea) textarea.value = currentNote || '';
    if (modal) modal.classList.remove('hidden');
    if (modal) modal.classList.add('flex');
    if (textarea) textarea.focus();
}
function closeEditModal() {
    const modal = document.getElementById('note-edit-modal');
    if (modal) modal.classList.add('hidden');
    if (modal) modal.classList.remove('flex');
    currentEditLogId = null;
    noteModalMode = null;
    // ØªÙ†Ø¸ÙŠÙ Ù†Øµ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©
    const textarea = document.getElementById('note-edit-text');
    if (textarea) textarea.value = '';
}
function submitNoteOrEdit() {
    const noteText = document.getElementById('note-edit-text').value || '';
    if (noteModalMode === 'edit') {
        if (!currentEditLogId) { closeEditModal(); return; }
        showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©...');
        callGAS('updateLogNote', [currentEditLogId, noteText], (res) => {
            if (res && (res.success === true || res.updated || res.status === 'ok')) {
                showNotification('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©', 'success');
                if (currentStudentData) {
                    callGAS('getStudentLog', [currentStudentData.StudentID], renderStudentLog, (err)=>{});
                }
                closeEditModal();
            } else {
                showNotification(`âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ${(res && res.message) ? res.message : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`, 'error');
            }
            hideLoading();
        }, (err) => {
            showNotification(`âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ${err}`, 'error');
            hideLoading();
        });
        return;
    }
    // Ø¥Ø¶Ø§ÙØ©/Ø®ØµÙ… Ù†Ù‚Ø·Ø© (Ø¨Ø¯ÙˆÙ† Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ¯Ø± Ù„Ø¥Ø­Ø³Ø§Ø³ Ø³Ø±ÙŠØ¹)
    if (!pendingStudentId || !pendingChangeValue) { closeEditModal(); return; }
    const studentID = pendingStudentId;
    const studentName = pendingStudentName;
    const changeValue = pendingChangeValue;
    // Ø£ØºÙ„Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙÙˆØ±Ø§Ù‹ Ù„Ø¥Ø­Ø³Ø§Ø³ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø³Ø±ÙŠØ¹
    closeEditModal();
    callGAS('recordBehavior', [studentID, currentTeacher.TeacherID, currentSubject, changeValue, noteText], 
        (res) => {
            if (res.success) {
                const actionVerb = changeValue > 0 ? 'Ø§Ù„Ø¥Ø¶Ø§ÙØ©' : 'Ø§Ù„Ø®ØµÙ…';
                showNotification(`âœ… ØªÙ… ${actionVerb} Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù„Ø·Ø§Ù„Ø¨ ${studentName}`, 'success');
                showCelebration(changeValue, studentName);
                const scoreElement = document.getElementById(`score-${studentID}`);
                if (scoreElement) scoreElement.textContent = res.newTotal;
                clearCache(`students:${currentClass || 'none'}`);
                loadStudents();
                loadTeacherLogs();
            } else {
                showNotification(`âŒ ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${res.message}`, 'error');
            }
        }, (err) => {
            showNotification(`âŒ ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${err}`, 'error');
        }
    );
}
function deleteLogEntry(logId) {
    openDeleteConfirm(logId);
}

let pendingDeleteLogId = null;
function openDeleteConfirm(logId){
    pendingDeleteLogId = logId;
    const modal = document.getElementById('confirm-delete-modal');
    if (modal){ modal.classList.remove('hidden'); modal.classList.add('flex'); }
}
function cancelDeleteLog(){
    const modal = document.getElementById('confirm-delete-modal');
    if (modal){ modal.classList.add('hidden'); modal.classList.remove('flex'); }
    pendingDeleteLogId = null;
}
function confirmDeleteLog(){
    if (!pendingDeleteLogId) { cancelDeleteLog(); return; }
    const logId = pendingDeleteLogId;
    cancelDeleteLog();
    // Ø¨Ø¯ÙˆÙ† Ù„ÙˆØ¯Ø± Ù„Ø¥Ø­Ø³Ø§Ø³ Ø³Ø±ÙŠØ¹
    callGAS('deleteLogEntry', [logId], (res) => {
        if (res && (res.success === true || res.deleted || res.status === 'ok')) {
            showNotification('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„', 'success');
            if (currentStudentData) {
                callGAS('getStudentLog', [currentStudentData.StudentID], renderStudentLog, (err)=>{});
            }
        } else {
            showNotification(`âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: ${(res && res.message) ? res.message : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`, 'error');
        }
    }, (err) => {
        showNotification(`âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: ${err}`, 'error');
    });
}

// ======================================================
// â­ Ø¹Ø§Ø±Ø¶ Ø§Ù„ØµÙˆØ±
// ======================================================
function openImageModal(src){
    const viewer = document.getElementById('image-viewer');
    const img = document.getElementById('image-viewer-img');
    if (img) img.src = src || '';
    if (viewer){ viewer.classList.remove('hidden'); viewer.classList.add('flex'); }
}
function closeImageModal(){
    const viewer = document.getElementById('image-viewer');
    if (viewer){ viewer.classList.add('hidden'); viewer.classList.remove('flex'); }
}

// ======================================================
// â­ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª (Ø§Ù„ÙƒØ§Ø´) ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­
// ======================================================
function writeCache(key, value){
    try{
        const item = { v: value, t: Date.now() };
        localStorage.setItem(key, JSON.stringify(item));
    }catch(e){ /* ignore */ }
}
function readCache(key){
    try{
        const raw = localStorage.getItem(key);
        if (!raw) return null;
        const item = JSON.parse(raw);
        if (Date.now() - (item.t || 0) > CACHE_TTL_MS) { localStorage.removeItem(key); return null; }
        return item.v;
    }catch(e){ return null; }
}
function clearCache(key){ try{ localStorage.removeItem(key);}catch(e){} }
function saveSessionToCache(){
    try{
        const sess = {
            teacher: currentTeacher,
            subject: currentSubject,
            subjectName: currentSubjectName,
            classId: currentClass,
            className: currentClassName
        };
        localStorage.setItem('session', JSON.stringify(sess));
    }catch(e){}
}
function restoreFromCache(){
    try{
        const raw = localStorage.getItem('session');
        if (!raw) return false;
        const sess = JSON.parse(raw);
        if (!sess || !sess.teacher) return false;
        currentTeacher = sess.teacher;
        currentSubject = sess.subject;
        currentSubjectName = sess.subjectName;
        currentClass = sess.classId;
        currentClassName = sess.className;
        // Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…
        document.getElementById('teacher-info').innerHTML = `
            <div style="animation: fadeIn 0.5s ease-out">
                <img src="${(currentTeacher && currentTeacher.PhotoURL) || 'https://via.placeholder.com/100'}" class="avatar mb-3">
                <h3 class="text-xl font-bold">${(currentTeacher && currentTeacher.TeacherName) || ''}</h3>
                <p class="text-sm text-gray-500">Ø§Ù„Ù…ÙˆØ§Ø¯: ${(currentTeacher && currentTeacher.Subjects ? currentTeacher.Subjects.join(', ') : '')}</p>
                <button onclick="logout()" class="mt-3 px-3 py-1 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>`;
        document.getElementById('sidebar').style.display = 'block';
        document.getElementById('teacher-name-display').textContent = (currentTeacher && currentTeacher.TeacherName) || '';
        if (currentSubject){
            document.getElementById('subject-name-display').textContent = currentSubjectName || currentSubject;
            showSection('classes-section');
            loadClasses();
        } else {
            loadSubjects((currentTeacher && currentTeacher.Subjects) || []);
        }
        if (currentClass){
            document.getElementById('class-name-display').textContent = currentClassName || '';
            loadStudents();
        }
        loadTeacherLogs();
        return true;
    }catch(e){ return false; }
}
function logout(){
    try{ localStorage.removeItem('session'); }catch(e){}
    // ÙŠÙ…ÙƒÙ† Ø£ÙŠØ¶Ø§Ù‹ Ù…Ø³Ø­ ÙƒØ§Ø´ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
    try{ Object.keys(localStorage).forEach(k=>{ if (k.startsWith('subjects:')||k.startsWith('classes:')||k.startsWith('students:')) localStorage.removeItem(k); }); }catch(e){}
    location.reload();
}

// ======================================================
// â­ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù…
// ======================================================

function loadTeacherLogs() {
    if (!currentTeacher || !currentTeacher.TeacherID) return;
    
    callGAS('getTeacherLogs', [currentTeacher.TeacherID], renderTeacherLogs, (err) => {
        console.error("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ù„Ù…:", err);
        document.getElementById('teacher-logs').innerHTML = `<p class="text-red-500 text-center text-sm py-4">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„.</p>`;
    });
}

function renderTeacherLogs(data) {
    const container = document.getElementById('teacher-logs');
    container.innerHTML = '';
    
    if (data.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">Ù„Ù… ØªÙ‚Ù… Ø¨ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ Ø¹Ù…Ù„ÙŠØ© Ø¨Ø¹Ø¯.</p>';
        document.getElementById('today-operations').textContent = '0';
        document.getElementById('today-students').textContent = '0';
        return;
    }
    
    const today = new Date().toDateString();
    const todayLogs = data.filter(log => {
        try {
            return new Date(log.Timestamp).toDateString() === today;
        } catch {
            return false;
        }
    });
    
    const uniqueStudents = new Set(data.map(log => log.StudentName));
    document.getElementById('today-operations').textContent = todayLogs.length;
    document.getElementById('today-students').textContent = uniqueStudents.size;
    
    const html = data.map((log, index) => {
        const color = log.Change > 0 ? 'text-green-600' : 'text-red-600';
        const bgColor = log.Change > 0 ? 'bg-green-50' : 'bg-red-50';
        const borderColor = log.Change > 0 ? 'border-r-green-500' : 'border-r-red-500';
        const sign = log.Change > 0 ? '+' : '';
        const noteDisplay = log.Note ? `<p class="text-xs text-blue-600 italic mt-1 bg-blue-50 p-1 rounded">ğŸ’¬ ${log.Note.substring(0, 30)}${log.Note.length > 30 ? '...' : ''}</p>` : '';
        
        return `
            <div class="p-3 border-b-2 last:border-b-0 ${bgColor} rounded-lg ${borderColor} hover:shadow-md transition-all" style="animation: slideIn 0.3s ease-out ${index * 0.1}s both;">
                <div class="flex justify-between items-start mb-1">
                    <p class="font-semibold">
                        <span class="${color} text-lg">${sign}${log.Change}</span>
                        <span class="text-xs text-gray-600"> Ù„Ù„Ø·Ø§Ù„Ø¨</span>
                    </p>
                    <span class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded-full">${log.Subject}</span>
                </div>
                <p class="font-bold text-gray-800 text-sm">ğŸ‘¤ ${log.StudentName}</p>
                ${noteDisplay}
                <p class="text-xs text-gray-400 mt-1">ğŸ• ${log.Timestamp}</p>
            </div>
        `;
    }).join('');
    container.innerHTML = html;
}

// ======================================================
// â­ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ
// ======================================================

function showAllClassesStats() {
    topProgressStart();
    if (allClassesStats && allClassesStats.length > 0) {
        renderAllClassesStats(allClassesStats);
        document.getElementById('all-classes-stats-modal').classList.remove('hidden');
        topProgressDone();
        return;
    }

    callGAS('getAllClassesStats', [currentSubject], (data) => {
        topProgressTo(85);
        renderAllClassesStats(data);
        document.getElementById('all-classes-stats-modal').classList.remove('hidden');
        topProgressDone();
    }, (err) => {
        showNotification("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØµÙÙˆÙ Ø§Ù„ÙƒÙ„ÙŠØ©: " + err, "error");
        topProgressDone();
    });
}

function closeAllClassesModal() {
    document.getElementById('all-classes-stats-modal').classList.add('hidden');
}

function renderAllClassesStats(data) {
    const content = document.getElementById('all-classes-content');
    
    if (!data || data.length === 0) {
        content.innerHTML = '<p class="text-center text-gray-500 py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</p>';
        return;
    }
    
    let totalStudents = 0;
    let totalScore = 0;
    let allScores = [];
    
    data.forEach(classData => {
        totalStudents += classData.students.length;
        classData.students.forEach(student => {
            totalScore += student.TotalScore;
            allScores.push(student.TotalScore);
        });
    });
    
    const overallAverage = totalStudents > 0 ? (totalScore / totalStudents).toFixed(1) : 0;
    const highestOverall = allScores.length > 0 ? Math.max(...allScores) : 0;
    const lowestOverall = allScores.length > 0 ? Math.min(...allScores) : 0;
    
    let html = `
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 mb-6 shadow-md">
            <h4 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span>ğŸ“ˆ</span>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© - ${currentSubjectName}
            </h4>
            <div class="grid grid-cols-4 gap-4">
                <div class="bg-white rounded-lg p-4 text-center shadow">
                    <p class="text-gray-600 text-sm mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</p>
                    <p class="text-3xl font-bold text-purple-600">${totalStudents}</p>
                </div>
                <div class="bg-white rounded-lg p-4 text-center shadow">
                    <p class="text-gray-600 text-sm mb-1">Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¹Ø§Ù…</p>
                    <p class="text-3xl font-bold text-blue-600">${overallAverage}</p>
                </div>
                <div class="bg-white rounded-lg p-4 text-center shadow">
                    <p class="text-gray-600 text-sm mb-1">Ø£Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø·</p>
                    <p class="text-3xl font-bold text-green-600">${highestOverall}</p>
                </div>
                <div class="bg-white rounded-lg p-4 text-center shadow">
                    <p class="text-gray-600 text-sm mb-1">Ø£Ù‚Ù„ Ù†Ù‚Ø§Ø·</p>
                    <p class="text-3xl font-bold text-red-600">${lowestOverall}</p>
                </div>
            </div>
        </div>
        
        <h4 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
            <span>ğŸ«</span>ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØµÙÙˆÙ
        </h4>
        <div class="space-y-4">
    `;
    
    data.forEach((classData, index) => {
        const students = classData.students;
        const classTotal = students.reduce((sum, s) => sum + s.TotalScore, 0);
        const classAvg = students.length > 0 ? (classTotal / students.length).toFixed(1) : 0;
        const classMax = students.length > 0 ? Math.max(...students.map(s => s.TotalScore)) : 0;
        const classMin = students.length > 0 ? Math.min(...students.map(s => s.TotalScore)) : 0;
        
        // Ø£ÙØ¶Ù„ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠÙŠÙ† (Ø­Ø³Ø¨ PositiveScore/Positive ÙˆØ¥Ù„Ø§ TotalScore)
        const getPos = (s) => (typeof s.PositiveScore === 'number') ? s.PositiveScore : (typeof s.Positive === 'number') ? s.Positive : (typeof s.TotalScore === 'number' ? s.TotalScore : 0);
        const posAll = [...students].filter(s => getPos(s) > 0).sort((a, b) => getPos(b) - getPos(a));
        const topStudents = posAll.slice(0, 3);
        // Ø£Ù‚Ù„ Ù†Ù‚Ø§Ø· (Ø·Ù„Ø§Ø¨ Ù„Ø¯ÙŠÙ‡Ù… Ù†Ù‚Ø§Ø· Ø³Ù„Ø¨ÙŠØ© ÙØ¹Ù„ÙŠØ§Ù‹):
        // Ø§Ù„Ø´Ø±Ø·: NegativeScore/Negative > 0 Ø£Ùˆ TotalScore < 0
        const getNegScore = (s) => (typeof s.NegativeScore === 'number') ? s.NegativeScore : (typeof s.Negative === 'number') ? s.Negative : 0;
        const isNegative = (s) => (getNegScore(s) > 0) || ((typeof s.TotalScore === 'number') && s.TotalScore < 0);
        const negFiltered = [...students].filter(isNegative).sort((a, b) => {
            const na = getNegScore(a), nb = getNegScore(b);
            if (nb !== na) return nb - na; // Ø§Ù„Ø£ÙƒØ«Ø± Ø³Ù„Ø¨ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ Ø¥Ø°Ø§ ØªÙˆÙØ±Øª Ù‚ÙŠÙ…Ø© Ø³Ù„Ø¨ÙŠØ© ØµØ±ÙŠØ­Ø©
            const ta = (typeof a.TotalScore === 'number') ? a.TotalScore : 0;
            const tb = (typeof b.TotalScore === 'number') ? b.TotalScore : 0;
            return ta - tb; // ÙˆØ¥Ù„Ø§ Ø§Ù„Ø£Ù‚Ù„ Ù…Ø¬Ù…ÙˆØ¹Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹
        });
        const topLow = negFiltered.slice(0, 3);
        
        html += `
            <div class="bg-white rounded-xl p-5 shadow-lg border border-gray-200" style="animation: slideIn 0.3s ease-out ${index * 0.1}s both;">
                <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-200">
                    <h5 class="text-lg font-bold text-gray-800">${classData.className}</h5>
                    <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-semibold">${students.length} Ø·Ø§Ù„Ø¨</span>
                </div>
                
                <div class="grid grid-cols-4 gap-3 mb-4">
                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500 mb-1">Ø§Ù„Ù…ØªÙˆØ³Ø·</p>
                        <p class="text-xl font-bold text-blue-600">${classAvg}</p>
                    </div>
                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500 mb-1">Ø§Ù„Ø£Ø¹Ù„Ù‰</p>
                        <p class="text-xl font-bold text-green-600">${classMax}</p>
                    </div>
                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500 mb-1">Ø§Ù„Ø£Ø¯Ù†Ù‰</p>
                        <p class="text-xl font-bold text-red-600">${classMin}</p>
                    </div>
                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500 mb-1">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</p>
                        <p class="text-xl font-bold text-purple-600">${classTotal}</p>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg p-3">
                    <p class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <span>ğŸ†</span>Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ØªÙ…ÙŠØ²ÙˆÙ† (Ø£Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø· Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©)
                    </p>
                    <div class="space-y-2">
                        ${topStudents.map((student, idx) => {
                            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
                            const colors = ['text-yellow-600', 'text-gray-500', 'text-orange-600'];
                            return `
                                <div class="flex justify-between items-center bg-white p-2 rounded-lg">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xl">${medals[idx]}</span>
                                        <span class="font-semibold ${colors[idx]}">${student.StudentName}</span>
                                    </div>
                                    <span class="font-bold text-green-600">+${getPos(student)}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    ${posAll.length > 3 ? `
                    <div class="mt-3">
                        <button class="px-3 py-1 text-xs rounded-full bg-emerald-100 text-emerald-700 hover:bg-emerald-200" onclick="toggleList('pos-${index}', this)">ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠÙŠÙ†</button>
                        <div id="pos-${index}" class="hidden mt-2 space-y-1">
                            ${posAll.slice(3).map(student => `
                                <div class=\"flex justify-between items-center bg-white p-2 rounded-lg\">
                                    <span class=\"font-semibold text-gray-700\">${student.StudentName}</span>
                                    <span class=\"font-bold text-green-600\">+${getPos(student)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>` : ''}
                </div>

                <div class="bg-gradient-to-r from-red-50 to-red-200 rounded-lg p-3 mt-3">
                    <p class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <span>â¬‡ï¸</span>Ø§Ù„Ø·Ù„Ø§Ø¨ Ø£Ù‚Ù„ Ù†Ù‚Ø§Ø· (Ø°ÙˆÙˆ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø³Ù„Ø¨ÙŠØ©)
                        <span class="ml-2 text-xs px-2 py-0.5 rounded-full bg-white text-slate-700 border border-slate-200">${negFiltered.length} Ø·Ø§Ù„Ø¨</span>
                    </p>
                    ${negFiltered.length === 0 ? `
                        <p class=\"text-sm text-gray-500 bg-white bg-opacity-60 border rounded-md p-2\">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ø°ÙˆÙˆ Ù†Ù‚Ø§Ø· Ø³Ù„Ø¨ÙŠØ© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØµÙ.</p>
                    ` : `
                        <div class=\"space-y-2\">
                            ${topLow.map((student, idx) => {
                                const icons = ['ğŸš«','âš ï¸','â—'];
                                const colors = ['text-red-700','text-red-600','text-red-500'];
                                const negVal = getNegScore(student) > 0 ? `-${getNegScore(student)}` : `${student.TotalScore || 0}`;
                                return `
                                    <div class=\"flex justify-between items-center bg-white p-2 rounded-lg\">
                                        <div class=\"flex items-center gap-2\">
                                            <span class=\"text-xl\">${icons[idx]}</span>
                                            <span class=\"font-semibold ${colors[idx]}\">${student.StudentName}</span>
                                        </div>
                                        <span class=\"font-bold text-red-700\">${negVal}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        ${negFiltered.length > 3 ? `
                        <div class=\"mt-3\">
                            <button class=\"px-3 py-1 text-xs rounded-full bg-red-100 text-red-700 hover:bg-red-200\" onclick=\"toggleList('low-${index}', this)\">ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ø£Ù‚Ù„ Ù†Ù‚Ø§Ø·</button>
                            <div id=\"low-${index}\" class=\"hidden mt-2 space-y-1\">
                                ${negFiltered.slice(3).map(student => `
                                    <div class=\"flex justify-between items-center bg-white p-2 rounded-lg\">
                                        <span class=\"font-semibold text-gray-700\">${student.StudentName}</span>
                                        <span class=\"font-bold text-red-700\">${getNegScore(student) > 0 ? '-' + getNegScore(student) : (student.TotalScore || 0)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>` : ''}
                    `}
                </div>
            </div>
        `;
    });

    html += '</div>';
    content.innerHTML = html;
}

// Ù…Ø³Ø§Ø¹Ø¯ Ø¨Ø³ÙŠØ· Ù„ÙØªØ­/Ø·ÙŠ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
function toggleList(id, btn){
    const el = document.getElementById(id);
    if (!el) return;
    const isHidden = el.classList.contains('hidden');
    if (isHidden){ el.classList.remove('hidden'); btn.textContent = btn.textContent.replace('ØªÙˆØ³ÙŠØ¹', 'Ø¥Ø®ÙØ§Ø¡'); }
    else { el.classList.add('hidden'); btn.textContent = btn.textContent.replace('Ø¥Ø®ÙØ§Ø¡', 'ØªÙˆØ³ÙŠØ¹'); }
}

// ======================================================
// â­ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
// ======================================================

function printStudentReport() {
    if (!currentStudentData || currentFilteredLogs.length === 0) {
        showNotification('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'warning');
        return;
    }
    
    const studentName = document.getElementById('modal-student-name').textContent;
    const className = document.getElementById('modal-student-class').textContent;
    const totalScore = document.getElementById('modal-total-score').textContent;
    const positiveScore = document.getElementById('modal-positive-score').textContent;
    const negativeScore = document.getElementById('modal-negative-score').textContent;
    const operationsCount = document.getElementById('modal-operations-count').textContent;
    
    const subjectStats = {};
    currentFilteredLogs.forEach(log => {
        if (!subjectStats[log.Subject]) {
            subjectStats[log.Subject] = { positive: 0, negative: 0, total: 0, count: 0 };
        }
        subjectStats[log.Subject].count++;
        if (log.Change > 0) {
            subjectStats[log.Subject].positive += log.Change;
        } else {
            subjectStats[log.Subject].negative += Math.abs(log.Change);
        }
        subjectStats[log.Subject].total = subjectStats[log.Subject].positive - subjectStats[log.Subject].negative;
    });
    
    const subjectStatsHTML = Object.entries(subjectStats).map(([subject, stats]) => `
        <div class="subject-stat-box">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <strong style="font-size: 16px;">${subject}</strong>
                <span style="padding: 4px 12px; border-radius: 20px; font-weight: bold; ${stats.total >= 0 ? 'background: #d1fae5; color: #065f46;' : 'background: #fee2e2; color: #991b1b;'}">${stats.total >= 0 ? '+' : ''}${stats.total}</span>
            </div>
            <div style="display: flex; gap: 15px; font-size: 14px; color: #6b7280;">
                <span style="color: #10b981;">âœ… ${stats.positive}</span>
                <span style="color: #ef4444;">âŒ ${stats.negative}</span>
                <span>ğŸ“Š ${stats.count} Ø¹Ù…Ù„ÙŠØ©</span>
            </div>
        </div>
    `).join('');
    
    const printWindow = window.open('', '_blank', 'width=800,height=600');
    
    const logsHTML = currentFilteredLogs.map(log => {
        let dateStr = 'ØªØ§Ø±ÙŠØ® ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        try {
            const date = new Date(log.Timestamp);
            dateStr = date.toLocaleDateString('ar-EG', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (e) {
            dateStr = String(log.Timestamp);
        }
        
        const changeClass = log.Change > 0 ? 'positive' : 'negative';
        const changeSign = log.Change > 0 ? '+' : '';
        
        return `
            <tr>
                <td>${dateStr}</td>
                <td>${log.TeacherName}</td>
                <td>${log.Subject}</td>
                <td class="${changeClass}">${changeSign}${log.Change}</td>
                <td>${log.NewTotal}</td>
                <td>${log.Note || '-'}</td>
            </tr>
        `;
    }).join('');
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø§Ù„Ø¨ - ${studentName}</title>
            <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body { 
                    font-family: 'Cairo', Arial, sans-serif; 
                    padding: 30px;
                    background: #f8f9fa;
                    color: #333;
                }
                .header { 
                    text-align: center; 
                    border-bottom: 4px solid #3b82f6; 
                    padding-bottom: 25px; 
                    margin-bottom: 40px;
                    background: white;
                    padding: 30px;
                    border-radius: 10px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                }
                .header h1 { 
                    color: #1e40af; 
                    margin: 15px 0;
                    font-size: 32px;
                }
                .header h2 {
                    color: #3b82f6;
                    margin: 10px 0;
                    font-size: 28px;
                }
                .header p {
                    color: #6b7280;
                    margin: 8px 0;
                }
                .stats { 
                    display: grid; 
                    grid-template-columns: repeat(4, 1fr); 
                    gap: 20px; 
                    margin-bottom: 40px; 
                }
                .stat-box { 
                    background: white;
                    border: 2px solid #e5e7eb; 
                    padding: 20px; 
                    text-align: center; 
                    border-radius: 12px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                }
                .stat-box h3 { 
                    margin: 0 0 10px 0; 
                    font-size: 16px; 
                    color: #6b7280; 
                }
                .stat-box p { 
                    margin: 0; 
                    font-size: 32px; 
                    font-weight: bold; 
                }
                .section-title {
                    color: #1e40af;
                    font-size: 24px;
                    margin: 30px 0 20px 0;
                    padding-bottom: 10px;
                    border-bottom: 2px solid #e5e7eb;
                }
                .subject-stats-container {
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 15px;
                    margin-bottom: 30px;
                }
                .subject-stat-box {
                    background: white;
                    padding: 15px;
                    border-radius: 10px;
                    border: 1px solid #e5e7eb;
                }
                .log-table { 
                    width: 100%; 
                    border-collapse: collapse; 
                    margin-top: 20px;
                    background: white;
                    border-radius: 10px;
                    overflow: hidden;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                }
                .log-table th, .log-table td { 
                    border: 1px solid #d1d5db; 
                    padding: 12px; 
                    text-align: right; 
                }
                .log-table th { 
                    background-color: #3b82f6; 
                    color: white;
                    font-weight: 700;
                }
                .log-table tr:nth-child(even) {
                    background-color: #f9fafb;
                }
                .positive { color: #10b981; font-weight: bold; }
                .negative { color: #ef4444; font-weight: bold; }
                .footer {
                    margin-top: 60px;
                    text-align: center;
                    color: #6b7280;
                    font-size: 14px;
                    border-top: 2px solid #e5e7eb;
                    padding-top: 20px;
                }
                @media print {
                    body { 
                        padding: 0;
                        background: white;
                    }
                    .no-print { display: none; }
                    .stat-box, .log-table {
                        box-shadow: none;
                    }
                }
                .print-btn {
                    position: fixed;
                    bottom: 30px;
                    left: 30px;
                    padding: 15px 35px;
                    background: #3b82f6;
                    color: white;
                    border: none;
                    border-radius: 10px;
                    cursor: pointer;
                    font-size: 18px;
                    font-weight: bold;
                    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
                    transition: all 0.3s;
                }
                .print-btn:hover {
                    background: #2563eb;
                    transform: translateY(-2px);
                    box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ğŸ«  ØªÙ‚Ø±ÙŠØ± Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø·Ø§Ù„Ø¨ - Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ</h1>
                <h2>${studentName}</h2>
                <p><strong>Ø§Ù„ØµÙ:</strong> ${className}</p>
                <p style="color: #6b7280; font-size: 15px;">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${new Date().toLocaleDateString('ar-EG', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                })}</p>
            </div>
            
            <div class="stats">
                <div class="stat-box">
                    <h3>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</h3>
                    <p style="color: #3b82f6;">ğŸ† ${totalScore}</p>
                </div>
                <div class="stat-box">
                    <h3>Ù†Ù‚Ø§Ø· Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©</h3>
                    <p style="color: #10b981;">âœ¨ ${positiveScore}</p>
                </div>
                <div class="stat-box">
                    <h3>Ù†Ù‚Ø§Ø· Ø³Ù„Ø¨ÙŠØ©</h3>
                    <p style="color: #ef4444;">âš ï¸ ${negativeScore}</p>
                </div>
                <div class="stat-box">
                    <h3>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
                    <p style="color: #8b5cf6;">ğŸ“Š ${operationsCount}</p>
                </div>
            </div>
            
            <h3 class="section-title">ğŸ“š Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø§Ø¯Ø©</h3>
            <div class="subject-stats-container">
                ${subjectStatsHTML}
            </div>
            
            <h3 class="section-title">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h3>
            <table class="log-table">
                <thead>
                    <tr>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ù…Ø¹Ù„Ù…</th>
                        <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                        <th>Ø§Ù„ØªØºÙŠÙŠØ±</th>
                        <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯</th>
                        <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                    </tr>
                </thead>
                <tbody>
                    ${logsHTML}
                </tbody>
            </table>
            
            <div class="footer">
                <p><strong>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ</strong></p>
                <p>Â© 2026-2027 - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</p>
            </div>
            
            <button class="print-btn no-print" onclick="window.print()">
                ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            </button>
        </body>
        </html>
    `);
    
    printWindow.document.close();
    setTimeout(() => {
        printWindow.focus();
    }, 500);
    
    showNotification('âœ… ØªÙ… ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©', 'success');
}

// ======================================================
// â­ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
// ======================================================

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
document.addEventListener('DOMContentLoaded', function() {
    if (!restoreFromCache()) {
        loadTeachers();
    }
    
    // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
    console.log("ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒÙØ§Ø¡Ø§Øª...");
    callGAS('testAPI', [], (data) => {
        console.log("âœ… Ø§ØªØµØ§Ù„ GAS Ù†Ø§Ø¬Ø­:", data);
    }, (err) => {
        console.error("âŒ ÙØ´Ù„ Ø§ØªØµØ§Ù„ GAS:", err);
    });
});
</script>

</body>
</html>
